name: DÃ©ploiement CI/CD de l'application Node.js sur EC2

on:
  push:
    branches:
      - main # DÃ©clencher ce workflow Ã  chaque 'push' sur la branche principale
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    
    # 1. RÃ©cupÃ©ration du code
    - name: ðŸ“¦ RÃ©cupÃ©ration du Code
      uses: actions/checkout@v4
      
    # # 2. Configuration de l'environnement Node.js (avec pnpm)
    # - name: âš™ï¸ Configuration de Node.js et pnpm
    #   uses: actions/setup-node@v4
    #   with:
    #     node-version: '20' # Assurez-vous d'utiliser la bonne version
    #     cache: 'pnpm'       # Active la mise en cache des dÃ©pendances pnpm
        
    - name: ðŸ“¥ Installation de pnpm
      run: npm install -g pnpm # Installe pnpm globalement
        
    # 3. Installation des dÃ©pendances et Build (ExÃ©cutÃ© sur GitHub)
    - name: ðŸ—ï¸ Installation (pnpm) et Construction du Projet
      run: |
        pnpm install  # Utilise pnpm pour installer les dÃ©pendances
        pnpm run build # Utilise pnpm pour lancer la commande de construction
        
    # --- DÃ©ploiement vers EC2 ---

    # 4. Transfert des Fichiers (SCP - Secure Copy)
    - name: ðŸ’¾ Transfert des Fichiers (SCP)
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "." 
        target: "/home/${{ secrets.EC2_USER }}/myapp" 
        
    # 5. RedÃ©marrage de l'Application (SSH - Remote Command)
    - name: ðŸ”„ RedÃ©marrage de l'Application (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          APP_DIR="/home/${{ secrets.EC2_USER }}/myapp" 
          # --- NOUVELLE LOGIQUE DE DÃ‰MARRAGE ---
          
          # 1. Se dÃ©placer dans le rÃ©pertoire de l'application transfÃ©rÃ©e
          cd $APP_DIR 
          
          # 2. ExÃ©cuter l'installation des dÃ©pendances de production
          # C'est souvent nÃ©cessaire si le build utilise des packages, mais l'exÃ©cution aussi.
          # Si le dossier 'build' est 100% autonome, sautez cette ligne.
          pnpm install --prod 

          # 3. DÃ©marrer/RedÃ©marrer PM2 en pointant vers le dossier 'build'
          # Nous supposons que le point d'entrÃ©e est dans 'build', et que PM2 doit s'y lancer.
          # S'il existe dÃ©jÃ , PM2 le met Ã  jour, sinon il le dÃ©marre.
          
          # --- OPTION 1: PM2 dÃ©marre le script direct dans /build ---
          # Remplacez index.js par votre point d'entrÃ©e rÃ©el (ex: server.js)
          PM2_COMMAND="pm2 start $APP_DIR/build/index.js --name \"my-node-app\""
          
          # Si l'application existe, utilisez 'reload' (pour un redÃ©marrage doux)
          # Sinon, utilisez la commande de 'start' complÃ¨te
          pm2 describe my-node-app > /dev/null
          if [ $? -eq 0 ]; then
            pm2 reload my-node-app
          else
            $PM2_COMMAND
          fi
          
          pm2 save 